name: Backend Workflow

on:
  - pull_request

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout under $GITHUB_WORKSPACE
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Build Backend Container
        run: docker compose build backend

      - name: Start Database Service
        run: docker compose up -d db

      - name: Wait for Database
        run: sleep 10

      # Run tests in batches - each gets a fresh container
      - name: Run Authentication Tests
        run: docker compose run --rm backend python manage.py test tests.test_jwt_authentication tests.test_user_model

      - name: Run Upload Tests
        run: docker compose run --rm backend python manage.py test tests.test_upload_view tests.test_upload_folder tests.test_upload_consent_and_ordering tests.test_upload_skips_files tests.test_upload_github_filter

      - name: Run Project Tests
        run: docker compose run --rm backend python manage.py test tests.test_project_endpoints tests.test_project_summary tests.test_project_classifier tests.test_project_metadata

      - name: Run Analyzer Tests
        run: docker compose run --rm backend python manage.py test tests.test_file_analyzers tests.test_skill_analyzer tests.test_resume_skill_extractor

      - name: Run Service Tests
        run: docker compose run --rm backend python manage.py test tests.test_folder_upload_service tests.test_upload_folder_with_classifier

      - name: Run Database Tests
        run: docker compose run --rm backend python manage.py test tests.test_database_saving tests.test_models tests.test_content_reading

      - name: Run LLM Tests
        run: docker compose run --rm backend python manage.py test tests.test_llm tests.test_local_llm tests.test_prompt_loader

      - name: Run Misc Tests
        run: docker compose run --rm backend python manage.py test tests.test_chronological_ordering tests.test_collaborative_tag tests.test_zip_timestamps

      - name: Cleanup
        if: always()
        run: docker compose down -v